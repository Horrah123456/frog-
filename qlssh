
const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");
const https = require("https");

const SCRIPT_NAME = path.basename(__filename, ".js");
const QL_BASE_LOG_DIR = "/ql/log";
const SCRIPT_LOG_DIR = path.join(QL_BASE_LOG_DIR, SCRIPT_NAME);
const TIMESTAMP = new Date().toISOString().replace(/[:T]/g, "_").split(".")[0];
const LOG_FILE = path.join(SCRIPT_LOG_DIR, `${SCRIPT_NAME}_${TIMESTAMP}.log`);

let logBuffer = "";

function log(level, msg) {
  const time = new Date().toTimeString().split(" ")[0];
  const line = `[${time}] [${level}] ${msg}`;
  logBuffer += line + "\n";
  console.log(line);
}

function initLog(accountIndex, config) {
  log("INFO", "==================================================================");
  log("INFO", `ğŸ”„ é’è›™ç»­æœŸSSHç™»å½•ï¼ˆè´¦å·${accountIndex}ï¼‰`);
  log("INFO", `ğŸ” ç›®æ ‡ä¿¡æ¯ï¼š`);
  log("INFO", `  ä¸»æœº: ${config.HOST}`);
  log("INFO", `  ç«¯å£: ${config.PORT}`);
  log("INFO", `  ç”¨æˆ·: ${config.USER}`);
  log("INFO", "==================================================================");
}

function networkCheck(host, port) {
  log("INFO", "ğŸ” æ­£åœ¨æ‰§è¡Œç½‘ç»œåŸºç¡€æ£€æŸ¥...");
  try {
    execSync(`ping -c 3 -W 2 ${host}`, { stdio: "ignore" });
    log("INFO", "ğŸŸ¢ ä¸»æœºå¯è¾¾");
  } catch {
    log("ERROR", "ğŸ”´ ä¸»æœºä¸å¯è¾¾");
    return false;
  }

  try {
    execSync(`nc -z -w 3 ${host} ${port}`, { stdio: "ignore" });
    log("INFO", `ğŸŸ¢ ç«¯å£å¼€æ”¾ (${port})`);
  } catch {
    log("ERROR", "ğŸ”´ ç«¯å£æœªå“åº”");
    return false;
  }

  return true;
}

function checkGFWBlocked(host, callback) {
  log("INFO", "ğŸŒ æ­£åœ¨æ£€æµ‹ VPS æ˜¯å¦è¢«å¢™...");
  const testUrl = `https://ping.chinaz.com/${host}`;

  https.get(testUrl, (res) => {
    let data = "";
    res.on("data", (chunk) => (data += chunk));
    res.on("end", () => {
      if (data.includes("è¶…æ—¶") || data.includes("è¯·æ±‚è¶…æ—¶") || data.includes("ä¸å¯è¾¾")) {
        log("WARN", "ğŸš§ VPS å¯èƒ½å·²è¢«å¢™ï¼ˆä¸­å›½èŠ‚ç‚¹æ— æ³• Ping é€šï¼‰");
        callback(true);
      } else {
        log("INFO", "ğŸŸ¢ VPS åœ¨ä¸­å›½èŠ‚ç‚¹å¯è®¿é—®ï¼Œæœªè¢«å¢™");
        callback(false);
      }
    });
  }).on("error", (err) => {
    log("ERROR", `âŒ VPSæ£€æµ‹å¤±è´¥ï¼š${err.message}`);
    callback(null);
  });
}

function testSSHLogin(config) {
  log("INFO", "â³ æ­£åœ¨å°è¯•SSHç™»å½•...");

  // æ¸…ç† known_hosts ä¸­å†²çªè®°å½•
  try {
    execSync(`ssh-keygen -R ${config.HOST}`, { stdio: "ignore" });
    log("INFO", `ğŸ§¹ å·²æ¸…ç† known_hosts ä¸­ ${config.HOST} çš„æ—§è®°å½•`);
  } catch (e) {
    log("WARN", `âš ï¸ æ¸…ç† known_hosts å¤±è´¥ï¼š${e.message}`);
  }

  try {
    const output = execSync(
      `sshpass -p '${config.PASSWORD}' ssh -p ${config.PORT} ${config.USER}@${config.HOST} \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -o ConnectTimeout=10 \
        -o PreferredAuthentications=password \
        -o PubkeyAuthentication=no \
        "echo 'è¿œç¨‹å‘½ä»¤æ‰§è¡ŒæˆåŠŸ'; date '+VPS å½“å‰æ—¶é—´ï¼š%Y-%m-%d %H:%M:%S'"`,
      { encoding: "utf-8" }
    );

    log("DEBUG", `å‘½ä»¤è¾“å‡º: ${output}`);

    if (output.includes("è¿œç¨‹å‘½ä»¤æ‰§è¡ŒæˆåŠŸ")) {
      log("SUCCESS", "ğŸ‰ SSHç™»å½•æˆåŠŸ");

      const extract = output
        .split("\n")
        .filter((line) => line.includes("VPS å½“å‰æ—¶é—´"))
        .join("\n");

      if (extract) {
        log("INFO", "ğŸ•’ VPS å½“å‰æ—¶é—´ï¼š");
        log("INFO", extract);
      }

      return true;
    } else {
      log("ERROR", "âŒ SSHç™»å½•å¤±è´¥");
      return false;
    }
  } catch (e) {
    log("ERROR", `âŒ SSHç™»å½•å¤±è´¥: ${e.message}`);
    return false;
  }
}

function pushToNotify() {
  log("INFO", "ğŸ“¤ æ­£åœ¨ä½¿ç”¨é’é¾™é€šçŸ¥æ¨¡å—æ¨é€å®Œæ•´æ—¥å¿—...");
  const SCRIPT_DIR = __dirname;
  const notifyScriptPath = path.join(SCRIPT_DIR, "sendNotify.js");

  if (!fs.existsSync(notifyScriptPath)) {
    log("ERROR", "âŒ æœªæ‰¾åˆ° sendNotify.js è„šæœ¬ï¼Œæ¨é€å¤±è´¥");
    return;
  }

  try {
    const notify = require(notifyScriptPath);
    const title = `ğŸ” å¤šè´¦å·SSHç™»å½•è¯Šæ–­æŠ¥å‘Š ${new Date().toLocaleString()}`;
    const content = logBuffer;

    if (typeof notify.sendNotify === "function") {
      notify.sendNotify(title, content);
      log("INFO", "âœ… æ¨é€æˆåŠŸ");
    } else {
      log("ERROR", "âŒ sendNotify.js ä¸­æœªæ‰¾åˆ° sendNotify æ–¹æ³•");
    }
  } catch (e) {
    log("ERROR", `âŒ æ¨é€å¤±è´¥ï¼š${e.message}`);
  }
}

function saveLogToFile() {
  try {
    fs.mkdirSync(SCRIPT_LOG_DIR, { recursive: true });
    fs.writeFileSync(LOG_FILE, logBuffer);
    log("INFO", `ğŸ“ æ—¥å¿—å·²ä¿å­˜åˆ° ${LOG_FILE}`);
  } catch (e) {
    log("ERROR", `âŒ æ—¥å¿—ä¿å­˜å¤±è´¥ï¼š${e.message}`);
  }
}

function loadAccounts() {
  const accounts = [];
  let index = 1;
  while (true) {
    const host = process.env[`SSH_HOST_${index}`];
    const port = process.env[`SSH_PORT_${index}`];
    const user = process.env[`SSH_USER_${index}`];
    const password = process.env[`SSH_PASSWORD_${index}`];

    if (!host || !port || !user || !password) break;

    accounts.push({
      index,
      HOST: host,
      PORT: port,
      USER: user,
      PASSWORD: password,
    });

    index++;
  }

  return accounts;
}

async function main() {
  log("INFO", `## è„šæœ¬å¯åŠ¨æ—¶é—´ï¼š${new Date().toLocaleString()}`);
  const accounts = loadAccounts();

  if (accounts.length === 0) {
    log("ERROR", "âŒ æœªé…ç½®ä»»ä½• SSH è´¦å·");
    return;
  }

  for (const config of accounts) {
    log("INFO", `================= å¼€å§‹è´¦å· ${config.index} =================`);
    initLog(config.index, config);

    if (!networkCheck(config.HOST, config.PORT)) {
      log("WARN", "âŒ ç½‘ç»œæ£€æŸ¥å¤±è´¥ï¼Œè·³è¿‡è¯¥è´¦å·");
      continue;
    }

    await new Promise((resolve) => {
      checkGFWBlocked(config.HOST, (isBlocked) => {
        if (isBlocked === true) {
          log("WARN", "âš ï¸ VPS å¯èƒ½è¢«å¢™");
        } else if (isBlocked === false) {
          log("INFO", "âœ… VPS æœªè¢«å¢™");
        } else {
          log("WARN", "âš ï¸ æ— æ³•åˆ¤æ–­ VPS æ˜¯å¦è¢«å¢™");
        }

        const success = testSSHLogin(config);
        if (!success) {
          log("ERROR", "âŒ ç™»å½•å¤±è´¥ï¼Œç»“æŸè¯¥è´¦å·æµç¨‹");
        } else {
          log("INFO", "âœ… ç™»å½•æµç¨‹å®Œæˆ");
        }

        resolve();
      });
    });

    log("INFO", `================= ç»“æŸè´¦å· ${config.index} =================\n`);
  }

  saveLogToFile();
  pushToNotify();
}

main();
